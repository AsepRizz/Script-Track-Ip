#!/usr/bin/env python3
"""
Track IP information using ipapi.co and ip-api.com with a Rich-powered UI.
"""

import json
import sys
from typing import Any, Dict, Optional

try:
    import requests  # type: ignore
except ImportError:
    requests = None

try:
    from rich import box
    from rich.align import Align
    from rich.console import Console
    from rich.panel import Panel
    from rich.prompt import Prompt
    from rich.table import Table
    from rich.text import Text
except ImportError as exc:  # pragma: no cover - richer output optional
    sys.stderr.write(
        "Rich is required for this script.\nInstall with: pip install rich requests\n"
    )
    raise SystemExit(1) from exc

console = Console()


def fetch_json(url: str) -> Dict[str, Any]:
    """Fetch JSON from URL using requests if available, fallback to urllib."""
    if requests:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        return response.json()

    from urllib.request import urlopen  # type: ignore

    with urlopen(url, timeout=10) as resp:  # noqa: S310 - URL controlled by code paths
        return json.loads(resp.read().decode())


def merged_ip_info(ip: Optional[str] = None) -> Dict[str, Any]:
    """Merge data from ipapi.co and ip-api.com for self or specific IP."""
    suffix = f"{ip}/" if ip else ""
    ipapi = fetch_json(f"https://ipapi.co/{suffix}json")
    ip_api = fetch_json(f"http://ip-api.com/json/{ip or ''}")
    return {
        "ip": ipapi.get("ip"),
        "city": ipapi.get("city"),
        "region": ipapi.get("region"),
        "country": ipapi.get("country_name"),
        "lat": ip_api.get("lat"),
        "lon": ip_api.get("lon"),
        "timezone": ip_api.get("timezone"),
        "postal": ip_api.get("zip"),
        "isp": ipapi.get("org") or ip_api.get("isp"),
        "asn": ipapi.get("asn") or ip_api.get("as"),
        "country_code": ipapi.get("country_code"),
        "currency": ipapi.get("currency"),
        "languages": ipapi.get("languages"),
        "calling_code": ipapi.get("country_calling_code"),
        "status": ip_api.get("status"),
        "message": ip_api.get("message"),
    }


def build_table(data: Dict[str, Any]) -> Table:
    """Render the IP info in a neat table."""
    table = Table(box=box.ROUNDED, expand=True, show_header=False, padding=(0, 1))
    rows = [
        ("IP Address", data.get("ip")),
        ("City", data.get("city")),
        ("Region", data.get("region")),
        ("Country", data.get("country")),
        ("Latitude", data.get("lat")),
        ("Longitude", data.get("lon")),
        ("Time Zone", data.get("timezone")),
        ("Postal Code", data.get("postal")),
        ("ISP", data.get("isp")),
        ("ASN", data.get("asn")),
        ("Country Code", data.get("country_code")),
        ("Currency", data.get("currency")),
        ("Languages", data.get("languages")),
        ("Calling Code", data.get("calling_code")),
    ]
    for label, value in rows:
        display = value if value not in (None, "") else "-"
        table.add_row(label, str(display))
    maps_link = (
        f"https://maps.google.com/?q={data.get('lat')},{data.get('lon')}"
        if data.get("lat") and data.get("lon")
        else "-"
    )
    table.add_row("Google Maps", maps_link)
    return table


def show_banner() -> None:
    """Display a banner styled panel."""
    title = Text("Track IP", style="bold yellow")
    subtitle = Text("by Asep Riezky", style="green")
    console.print(
        Panel(
            Align.center(Text("\n".join([title.plain, subtitle.plain]), justify="center")),
            border_style="cyan",
            padding=(1, 2),
        )
    )


def show_info(ip: Optional[str] = None) -> None:
    """Fetch and display IP info."""
    data = merged_ip_info(ip)
    if data.get("status") == "fail":
        console.print(
            Panel(
                f"Request failed: {data.get('message', 'Unknown error')}",
                border_style="red",
            )
        )
        return

    heading = f"Your IP" if ip is None else f"Target IP: {ip}"
    console.print(Panel(build_table(data), title=heading, border_style="bright_magenta"))


def main() -> None:
    while True:
        console.clear()
        show_banner()
        console.print(
            Panel(
                "\n".join(
                    [
                        "[bold cyan]1[/] Track my public IP",
                        "[bold cyan]2[/] Track specific IP",
                        "[bold cyan]0[/] Exit",
                    ]
                ),
                title="Menu",
                border_style="blue",
                padding=(1, 2),
            )
        )
        choice = Prompt.ask("Select option", choices=["0", "1", "2"], default="0")
        if choice == "1":
            show_info()
        elif choice == "2":
            target = Prompt.ask("Enter target IP")
            show_info(target.strip())
        else:
            console.print("Goodbye!", style="bold green")
            break
        Prompt.ask("\nPress Enter to return to menu", default="", show_default=False)
        console.clear()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        console.print("\nInterrupted. Bye!", style="red")
